#!/usr/bin/env bash
norm=0
bold=1
dim=2
blink=5

lred=91
lgreen=92
lorgange=208

end="\e[0m"
endps="\[$end\]"

function get_color () {
    ret="\e["

    if [ $1 ]; then
        ret=$ret$1

        if [ $2 ]; then
            ret=$ret';'$2

            if [ $3 ]; then
                ret=$ret';'$3
            fi
        fi
    else
        ret=$ret'0'
    fi

    echo $ret'm'
}

function get_color_ps () {
    echo "\[$(get_color $1 $2 $3)\]"
}

function echo_bad_exit () {
    le=$?

    if [[ $le = 0 ]]; then
        echo -e "$(get_color $norm $lgreen)$le$end"
    else
        echo -e "$(get_color $bold $lred)$le$end"
    fi
}

function in_home () {
    echo $(pwd | grep -c ^$HOME)
}

function is_git_repo () {
    git status 2> /dev/null
}

function git_get_filechanges () {
    echo $(git diff --shortstat  | sed -E 's/^.+([0-9]+) f.+$/\1/')
}

function git_get_insertions () {
    echo $(git diff --shortstat | sed -E 's/^.+ ([0-9]+) i.+$/\1/')
}

function git_get_deletions () {
    echo $(git diff --shortstat | sed -E 's/^.+ ([0-9]+) d.+$/\1/')
}

function echo_git_stats () {
    if [ "$(is_git_repo)" ]; then
        fch=$(git_get_filechanges)
        ins=$(git_get_insertions)
        del=$(git_get_deletions)
        gss=$(git diff --shortstat | sed -e 's/^ *//g' -e 's/ *$//g')

        [[ "$fch" = "$gss" ]] || [ "$fch" ] || fch=0
        [[ "$ins" = "$gss" ]] || [ "$ins" ] || ins=0
        [[ "$del" = "$gss" ]] || [ "$del" ] || del=0

        export fch
        export ins
        export del
        export gss

        fccolor=$(get_color $norm $lgreen)

        if [[ "$fch" = 4 ]]; then
            fccolor=$(get_color $norm $lorange)
        elif [[ "$fch" -gt 4 ]]; then
            fccolor=$(get_color $norm $lred)
        fi

        if [ $(( $fch + $ins + $del )) -ne 0 ]; then
            echo -e "[$fccolor$fch$end $(get_color $norm $lgreen)+$ins$end $(get_color $norm $lred)-$del$end]"
        else
            echo -e "[$(get_color $norm lgreen)0$end]"
        fi
    fi
}

function preprompt () {
    echo $(echo_bad_exit) $(echo_git_stats)

    if [[ $(in_home) = 1 ]]; then
        export PS1="\h:$(get_color_ps $bold $lgreen)[$endps\W$(get_color_ps $bold $lgreen)]$endps "
    else
        export PS1="\h:$(get_color_ps $bold $lred)[$endps\w$(get_color_ps $bold $lred)]$endps "
    fi

    if [[ $(id -u) = 0 ]]; then
        export PS1=$PS1$(get_color_ps $blink $lred)'\u'$endps$(get_color_ps $bold $lred)'\$'$endps' '
    else
        export PS1=$PS1$(get_color_ps $norm $lgreen)'\u'$endps$(get_color_ps $bold $lgreen)'\$'$endps' '
    fi
}

export PROMPT_COMMAND=preprompt
